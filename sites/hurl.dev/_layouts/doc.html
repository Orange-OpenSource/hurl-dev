<!doctype html>
<html lang="en">
    <head>
        {% include head.html %}
        <script type="text/javascript">
            let toc; // A map of toc entry - target
            let visibleLinks = new Set(); // Set of actives nodes
            let lastVisibleLink;   // Last visibles links.

            function buildToc() {
                const lis = document.querySelectorAll(".doc-toc li");
                const map = new Map();
                [...lis].forEach(link => {
                    const a = link.querySelector("a");
                    const href = a.getAttribute("href");
                    const match = href.match(/^.*(#.*)$/);
                    const targetId = match[1];
                    const target = document.querySelector(targetId);
                    map.set(target, link);
                });
                return map;
            }

            function addClass(el, value) {
                if (el && !el.classList.contains(value)) {
                    el.classList.add(value);
                }
            }

            function onIntersect(entries) {
                entries.forEach((entry) => {
                    const target = entry.target;
                    const link = toc.get(target);
                    if (entry.isIntersecting && entry.intersectionRatio === 1.0) {
                        visibleLinks.add(link);
                    } else {
                        if (visibleLinks.size === 1) {
                            lastVisibleLink = link;
                        }
                        visibleLinks.delete(link);
                    }
                });
                highlightVisible();
            }

            function highlightVisible() {
                const links = [...toc.values()];
                const firstVisibleLink = links.find(link => visibleLinks.has(link));
                links.forEach(link => link.classList.remove("visible"));
                if (firstVisibleLink) {
                    addClass(firstVisibleLink, "visible");
                } else {
                    addClass(lastVisibleLink, "visible");
                }
            }

            function loadScrollObserver() {
                let options = {
                    root: null,
                    rootMargin: "-64px 0px 0px 0px",
                    threshold: 1.0
                };
                let observer = new IntersectionObserver(onIntersect, options);
                for (const target of toc.keys()) {
                    observer.observe(target);
                }
            }

            function onPickerSelectChange(url) {
                location = url;
            }

            if(!!window.IntersectionObserver) {
                window.addEventListener("load", () => {
                    toc = buildToc();
                    loadScrollObserver();
                });
            }
        </script>
    </head>
    <body>
        <div>
            {% include top-nav.html docs=site.data.docs title=page.title%}

            <div class="doc">

                {% include side-nav.html docs=site.data.docs title=page.title%}

                {% if page.indexed == nil %}
                    {% assign indexed = "true" %}
                {% elsif page.indexed %}
                    {% assign indexed = "true" %}
                {% else %}
                    {% assign indexed = "false" %}
                {% endif %}

                <div class="doc-content" data-section="{{ page.section }}" data-indexed="{{ indexed }}">

                    <div class="doc-content-col">

                        {% include doc-picker.html docs=site.data.docs title=page.title %}


                        {{ content }}

                        {% capture doc_url %}https://github.com/Orange-OpenSource/hurl/edit/master/docs/{{ page.path }}{% endcapture %}

                        <div class="doc-content-edit-page">
                            <a href="{{ doc_url | remove: '/_docs' }}">Edit this page</a>
                        </div>

                        <div class="doc-content-browse">

                            {% assign cur = false %}
                            {% assign prev = false %}
                            {% assign next = false %}

                            {% for li0 in site.data.docs %}
                                {% for li1 in li0.items %}

                                {% if cur and next == false %}
                                    {% assign next = li1 %}
                                    {% capture next_url %}{{ li1.path }}{% endcapture %}
                                {% endif %}

                                {% if li1.title == page.title %}
                                    {% assign cur = li1 %}
                                {% endif %}

                                {% unless cur %}
                                    {% assign prev = li1 %}
                                    {% capture prev_url %}{{ li1.path }}{% endcapture %}
                                {% endunless %}

                                {% endfor %}
                            {% endfor %}

                            {% if prev %}
                                {% unless prev.url %}
                            <div class="doc-content-browse-previous"><a href="{{ prev_url | prepend: site.baseurl }}">< {{ prev.title }}</a></div>
                                {% endunless %}
                            {% endif %}
                            {% if next %}
                                {% unless next.url %}
                            <div class="doc-content-browse-next"><a href="{{ next_url | prepend: site.baseurl }}">{{ next.title }} ></a></div>
                                {% endunless %}
                            {% endif %}
                        </div>

                        <div class="doc-footer">
                            {% include footer.html %}
                        </div>
                    </div>
                </div>

                <div class="doc-toc u-d-block-lg">
                    {% include doc-toc.html docs=site.data.docs title=page.title %}
                </div>

            </div>


        </div>


    </body>
</html>
